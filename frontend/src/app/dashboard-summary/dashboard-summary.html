<div class="min-h-screen bg-gray-50 pb-12">
  
  <div class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        
        <div class="flex items-center gap-3">
          <div class="p-2 bg-green-100 rounded-lg text-green-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-800 tracking-tight">สรุปผลงานภาพรวม</h1>
            <p class="text-sm text-gray-500">ติดตามความคืบหน้าตัวชี้วัดและเป้าหมาย</p>
            <span *ngIf="selectedDistrict !== 'all'" class="text-green-600 font-bold ml-1 animate-pulse">
                 — อำเภอ{{ selectedDistrict }}
            </span>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
          
          <a routerLink="/dashboard" 
             class="flex items-center gap-2 bg-white hover:bg-gray-100 text-gray-700 border border-gray-300 px-4 py-2 rounded-md shadow-sm transition font-medium cursor-pointer text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            กลับหน้าบันทึก
          </a>

          <div class="h-6 w-px bg-gray-300 mx-1 hidden md:block"></div>

          <div class="flex items-center gap-2">
            <label class="text-sm font-semibold text-gray-600">ปีงบ:</label>
            <div class="relative">
              <select [(ngModel)]="selectedYear" (change)="fetchData()" 
                      class="appearance-none bg-white border border-gray-300 text-gray-700 py-2 pl-3 pr-8 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm font-medium cursor-pointer">
                <option *ngFor="let y of years; trackBy: trackByKpi" [value]="y">{{ y }}</option>
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm font-semibold text-gray-600">อำเภอ:</label>
            <div class="relative">
              <select [(ngModel)]="selectedDistrict" (change)="fetchData()" 
                      class="appearance-none bg-white border border-gray-300 text-gray-700 py-2 pl-3 pr-8 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm font-medium cursor-pointer min-w-[150px]">
                <option value="all">-- ทั้งหมด --</option>
                <option *ngFor="let d of districts; trackBy: trackByKpi" [value]="d">{{ d }}</option>
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="container mx-auto px-4 mt-8">

    <div *ngIf="!isLoading && objectKeys(groupedData).length === 0" 
         class="flex flex-col items-center justify-center py-16 bg-white rounded-xl shadow-sm border border-dashed border-gray-300 animate-fade-in">
      
      <div class="bg-gray-100 p-4 rounded-full mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <h3 class="text-lg font-medium text-gray-900">ไม่พบข้อมูลตามเงื่อนไข</h3>
      <p class="text-gray-500 mt-1">ลองเปลี่ยนปีงบประมาณ หรือเลือกอำเภออื่น</p>
    </div>

    <div *ngFor="let issue of objectKeys(groupedData); trackBy: trackByKpi" class="mb-8 bg-white rounded-xl shadow-md overflow-hidden border border-gray-100 hover:shadow-lg transition-shadow duration-300">
      
      <div class="bg-gradient-to-r from-green-600 to-emerald-500 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
           <div class="bg-white/20 p-1.5 rounded-md backdrop-blur-sm">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
             </svg>
           </div>
           <h3 class="text-lg font-bold text-white tracking-wide shadow-black drop-shadow-sm">{{ issue }}</h3>
        </div>
        </div>

      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-gray-50 border-b border-gray-200">
              <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider w-1/2">ตัวชี้วัด (KPI)</th>
              <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-center w-32">เป้าหมาย</th>
              <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-center w-32">ผลงาน</th>
              <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-center w-1/4">ความก้าวหน้า</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            
            <tr *ngFor="let item of groupedData[issue]; trackBy: trackByKpi" class="hover:bg-green-50/30 transition-colors duration-150 group">
              
              <td class="px-6 py-4 text-sm text-gray-700 font-medium group-hover:text-green-800">
                <div class="flex items-start gap-2">
                  <span class="mt-1 h-1.5 w-1.5 rounded-full bg-green-400 flex-shrink-0"></span>
                  {{ item.kpi_name }}
                </div>
              </td>

              <td class="px-6 py-4 text-center">
                <span class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200 min-w-[60px]">
                  {{ item.total_target | number }}
                </span>
              </td>

              <td class="px-6 py-4 text-center">
                <span class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100 min-w-[60px]">
                  {{ item.total_result | number }}
                </span>
              </td>

              <td class="px-6 py-4 align-middle">
                <div class="w-full max-w-xs mx-auto">
                  
                  <div class="flex justify-between items-end mb-1">
                    <span class="text-xs font-semibold text-gray-600">
                      {{ calculateProgress(item.total_target, item.total_result) | number:'1.0-2' }}%
                    </span>
                  </div>

                  <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden shadow-inner">
                    <div *ngIf="calculateProgress(item.total_target, item.total_result) <= 100"
                         class="bg-green-500 h-2.5 rounded-full transition-all duration-700 ease-out shadow"
                         [style.width.%]="calculateProgress(item.total_target, item.total_result)">
                    </div>
                    
                    <div *ngIf="calculateProgress(item.total_target, item.total_result) > 100"
                         class="bg-gradient-to-r from-yellow-400 to-orange-500 h-2.5 rounded-full transition-all duration-700 ease-out shadow relative"
                         [style.width.%]="100">
                         <span class="absolute inset-0 bg-white opacity-20 animate-pulse"></span>
                    </div>
                  </div>

                </div>
              </td>

            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="bg-gray-50 px-6 py-2 border-t border-gray-100">
        <p class="text-xs text-right text-gray-400">ข้อมูลล่าสุด: {{ selectedYear }}</p>
      </div>

    </div>

  </div>

</div>